<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eliminar producto</title>
</head>

<body>
    <main>
        <h1>Eliminar producto</h1>

        <form id="getProduct-form">
            <label for="idProd">Id del producto</label>
            <input type="number" name="idProd" id="idProd" required>
            <input type="submit" value="Consultar producto">
        </form>
        <hr>
        <section id="products-container">
            <ul id="products-list"></ul>
        </section>
        <section id="updateFormContainer">

        </section>
    </main>


    <script>
        let productList = document.getElementById("products-list");
        let getProductForm = document.getElementById("getProduct-form");
        let url = "http://localhost:3000";
        let updateFormContainer = document.getElementById("updateFormContainer")

        getProductForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            console.log("ESTE ES EL EVENTO",event);
            console.log("Y ESTE EL EVENT.TARGET", event.target);
            let formData = new FormData(event.target);
            let data = Object.fromEntries(formData.entries());
            let idProd = data.idProd; //Ahora q mi form es objeto puedo guardar el id en una variable
            console.log(idProd);

            console.log(`Haciendo una peticion GET a la url ${url}/productos/${idProd}`);

            let response = await fetch(`${url}/productos/${idProd}`);
            let datos = await response.json();
            

            //Para extraer la respuesta payload
            let product = datos.payload[0]

            let htmlProduct = `
                <li class="li-product">
                    <img class="product-img" src="${product.img}">
                    <p>Id : ${product.id} | Nombre: ${product.nombre}</p>
                </li>
                <li class="li-boxButton">
                     <input type="button" value="Actualizar producto" id="updateProduct-button">
                </li>
            `;
            productList.innerHTML = htmlProduct;

            let updateProduct_button = document.getElementById("updateProduct-button");
            
            updateProduct_button.addEventListener("click", event => {
                event.stopPropagation();

                createForm(product);
            })
        });

        async function createForm(product){
            console.table(product)

            let updateProductsFormHTML = `
            <form id="altaProducts-container" class="form-alta">
                
            <input type="hidden" name="id" id="idProd" value="${product.id}">   
            <label for="nameProd">Nombre</label>
            <input type="text" name="nombre" id="nameProd" value="${product.nombre}" required>
    
            <label for="imageProd">Imagen</label>
            <input type="text" name="img" id="imageProd" value="${product.img}" required>
    
            <label for="priceProd">Precio</label>
            <input type="number" name="precio" id="priceProd" value="${product.precio}" required>
    
            <label for="categoryProd">Categoria</label>
            <select name="categoria" id="categoryProd" required>
                <option value="suplemento">Suplemento</option>
                <option value="ropa_deportiva">Ropa deportiva</option>
            </select>
 
            <input type="hidden" name="activo" id="activoProd" value="${product.activo}">   

            <input type="submit" value="Crear producto">
        </form>
        `;
        updateFormContainer.innerHTML = updateProductsFormHTML;

        let updateProducts_form = document.getElementById("altaProducts-container");
        updateProducts_form.addEventListener("submit", event => {
            updateProduct(event);
        });

        }
        
        async function updateProduct(event) {
            event.preventDefault();
            event.stopPropagation();

            console.log("Preparando datos del form para el PUT")
            
            let formData = new FormData(event.target);
            let data = Object.fromEntries(formData.entries());
            console.log(data);

            try {
                let response = await fetch(`${url}/productos`,{
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json" 
                    },
                    body: JSON.stringify(data)
                });
                let result = await response.json();
                console.log(result);

                if(response.ok){
                    console.log(result.message);
                    alert(result.message);
                } else{
                    //HACER
                    console.log(result.message);
                    alert(result.message);
                }
            } catch (error) {
                
            }
        }
    </script>
</body>

</html>